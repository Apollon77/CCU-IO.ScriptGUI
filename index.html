<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>

    <script type="text/javascript" src="js/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.10.3.custom.js"></script>
    <script type="text/javascript" src="js/jquery.ui.multiselect.js"></script>
    <script type="text/javascript" src="js/alsoDrag.js"></script>

    <script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>

    <script type="text/javascript" src="js/jquery.ba-resize.min.js"></script>
    <script type="text/javascript" src="js/mousehold.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.js"></script>
    <script type="text/javascript" src="js/aplweb.scrollbars.js"></script>



    <script type="text/javascript" src="js/jquery.jsPlumb-1.5.3.js"></script>

    <link rel="stylesheet" href="css/Main.css"/>
    <link rel="stylesheet" href="css/jquery.ui.multiselect.css"/>
    <link rel="stylesheet" href="css/dark-hive/jquery-ui-1.10.3.custom.css"/>
    <link rel="stylesheet" href="css/scrollbars.css"/>
    <link rel="stylesheet" href="css/scrollbars-black.css"/>
    <link rel="stylesheet" href="css/ui-menu-horizontal.css"/>

    <!--<input id="btn_struc" type="button" value="make Stucktur"/>-->
    <!--<input id="btn_repaint" type="button" value="Repaint"/>-->
    <!--<input id="btn_test" type="button" value="Teste etwas"/>-->
</head>

<body class="ui-widget-content">
<!--<body >-->

<div id="menu_body" class="menu_body ui-state-default">
    <ul id="menu" class=" menu ">
        <li><a class="menu_font " href="#">Datei</a>
            <ul>
                <li><a class="menu_font" href="#">Neu</a></li>
                <li><a class="menu_font" href="#">Öffnen</a></li>
                <li><a class="menu_font" href="#">Speichern</a></li>
                <li><a class="menu_font" href="#">Speichern als</a></li>
                <li><a class="menu_font" href="#">Export</a></li>
            </ul>
        </li>
        <li><a class="menu_font" href="#">Einstellungen</a>
            <ul>
                <li><a class="menu_font l" href="#">Theme</a>
                    <ul>
                        <li><a class="menu_font" href="#">Dark-Hive</a></li>
                        <li><a class="menu_font" href="#">Empty</a></li>
                        <li><a class="menu_font" href="#">Empty</a></li>
                        <li><a class="menu_font" href="#">Empty</a></li>
                    </ul>
                </li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
            </ul>
        </li>
        <li><a class="menu_font " href="#">Compile</a>
            <ul>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>

            </ul>
        </li>
        <li><a class="menu_font " href="#">Test</a>
            <ul>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>

            </ul>
        </li>
        <li><a class="menu_font" href="#">Help</a>
            <ul>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>
                <li><a class="menu_font" href="#">Empty</a></li>

            </ul>
        </li>
    </ul>
</div>
<div id="icon_bar" class="icon_bar ui-state-default">

    <img src="img/icon/shape_align_left.png" class="img_iconbar set_algin" id="img_set_left"/>
    <img src="img/icon/shape_align_right.png" class="img_iconbar set_algin" id="img_set_right"/>
    <img src="img/icon/shape_align_top.png" class="img_iconbar set_algin" id="img_set_top"/>
    <img src="img/icon/shape_align_bottom.png" class="img_iconbar set_algin" id="img_set_bottom"/>
    <img src="img/icon/shape_move_back.png" class="img_iconbar set_algin" id="img_set_steps"/>

    <img src="img/icon/zoom.png" class="img_iconbar set_zoom" id="img_set_zoom"/>
    <img src="img/icon/zoom_in.png" class="img_iconbar set_zoom" id="img_set_zoom_in"/>
    <img src="img/icon/zoom_out.png" class="img_iconbar set_zoom" id="img_set_zoom_out"/>



</div>

<div class="main">
    <select id="toolbox_select" class="toolbox_select">
        <option value="logic">Logic</option>
        <option value="io">I/O</option>
        <option value="timer">Timer</option>
        <option value="option4">Option 4</option>
        <option value="option5">Option 5</option>
    </select>

    <div id="toolbox_body" class="toolbox_body">
        <div id="toolbox_logic" class="toolbox">
            <div id="und" class="fbs">
                <a style="font-size: 12px">und </a>
            </div>
            <div id="oder" class="fbs">
                <p>Ich bin ein </p>

                <p>oder </p>
            </div>
        </div>
        <div id="toolbox_io" class="toolbox">
            <div id="input" class="fbs">
                <p>Ich bin ein</p>

                <p>input </p>
            </div>
            <div id="output" class="fbs">
                <p>Ich bin ein </p>

                <p>output</p>
            </div>
        </div>

    </div>
    <div id="prg_body" class="prg_body">
        <section id="prg_panel" class="prg_panel">
        </section>
    </div>
</div>
<script type="text/javascript">
var ScriptGUI = {

    Main: function () {

        $("#menu").menu({position: {at: "left bottom"}});


        $("#toolbox_body").scrollbars();
        $("#prg_body").scrollbars();


        $(".toolbox").hide();
        $("#toolbox_logic").show();


        // Aufzeigen der Default mit XXX gekennzeichnet wurde geändert
        jsPlumb.Defaults = {
            Anchor: "BottomCenter",
            Anchors: [ null, null ],
            ConnectionsDetachable: true,
            ConnectionOverlays: [],
            Connector: "Bezier",
            Container: $("#prg_panel"),                             //xxx
            DoNotThrowErrors: false,
            DragOptions: { },
            DropOptions: { },
            Endpoint: "Dot",
            Endpoints: [ null, null ],
            EndpointOverlays: [ ],
            EndpointStyle: { fillStyle: "#456" },
            EndpointStyles: [ null, null ],
            EndpointHoverStyle: null,
            EndpointHoverStyles: [ null, null ],
            HoverPaintStyle: null,
            LabelStyle: { color: "black" },
            LogEnabled: false,
            Overlays: [ ],
            MaxConnections: 1,
            PaintStyle: { lineWidth: 4, strokeStyle: "blue" },      //xxx
            ReattachConnections: false,
            RenderMode: "svg",
            Scope: "jsPlumb_DefaultScope"
        };

        jsPlumb.bind("click", function (conn) {
            jsPlumb.detach(conn);

        });


        var counter = 0;

        //Make element draggable
        $(".fbs").draggable({
            helper: 'clone',
            containment: "body",
            zIndex: 100,

//            grid: [ 30, 30 ],


        });

        //Make element droppable
        $(".prg_panel").droppable({
            drop: function (ev, ui) {
                console.log(ui);


                var type = $(ui["draggable"][0]).attr("id");
                var top = ui["offset"]["top"] - $("#prg_panel").offset().top;
                var left = ui["offset"]["left"] - $("#prg_panel").offset().left;

                console.log(top);
                console.log(left);
                //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                if (type == "und") {

                    $("#prg_panel").append('\
                             <div id="und_' + counter + '" class="fbs_element">\
                                <div id="head_' + counter + '"  class="div_head" style="background-color: green">\
                                    <a class="head_font">' + type + '</a>\
                                </div>\
                                <div id="left_' + counter + '" class="div_left">\
                                    <div id="und_' + counter + '_in1"  class="div_input und_' + counter + '_in"><a class="input_font">IN 1</a></div>\
                                    <div id="und_' + counter + '_in2"  class="div_input und_' + counter + '_in"><a class="input_font">IN 2</a></div>\
                                </div>\
                                <div id="right_' + counter + '" class="div_right">\
                                    <div id="und_' + counter + '_out1" class="div_output1 und_' + counter + '_out"><a class="output_font">OUT</a></div>\
                                </div>\
                                <div id="add_input_' + counter + '" class="div_foot">\
                                    <input type="button" class="btn_add_input" id="btn_add_input_' + counter + '"></input>\
                                </div>\
                            </div>');


                }
                //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                if (type == "oder") {
                    $("#prg_panel").append('\
                             <div id="oder_' + counter + '" class="fbs_element">\
                                <div id="head_' + counter + '"  class="div_head" style="background-color: green">\
                                    <a class="head_font">' + type + '</a>\
                                </div>\
                                <div id="left_' + counter + '" class="div_left">\
                                    <div id="oder_' + counter + '_in1"  class="div_input oder_' + counter + '_in"><a class="input_font">IN 1</a></div>\
                                    <div id="oder_' + counter + '_in2"  class="div_input oder_' + counter + '_in"><a class="input_font">IN 2</a></div>\
                                </div>\
                                <div id="right_' + counter + '" class="div_right">\
                                    <div id="oder_' + counter + '_out1" class="div_output1 oder_' + counter + '_out"><a class="output_font">OUT</a></div>\
                                </div>\
                                 <div id="add_input_' + counter + '" class="div_foot">\
                                    <input type="button" class="btn_add_input" id="btn_add_input_' + counter + '"></input>\
                                </div>\
                             </div>');
                }
                //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                if (type == "input") {
                    $("#prg_panel").append('<div id="input_' + counter + '" class="fbs_element">\
                            <div id="left_' + counter + '" class="div_left">\
                            </div>\
                            <div id="right_' + counter + '" class="div_right">\
                                <div id="input_' + counter + '_out1" class="div_output1 input_' + counter + '_out"></div>\
                            </div>\
                    <div style="position: absolute; width: 100%; top: 0"> Ich bin ein input</div> \
                    </div>');

                }
                //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                if (type == "output") {
                    $("#prg_panel").append('<div id="output_' + counter + '" class="fbs_element">\
                            <div id="left_' + counter + '" class="div_left">\
                                <div id="output_' + counter + '_in1"  class="div_input output_' + counter + '_in"></div>\
                            </div>\
                            <div id="right_' + counter + '" class="div_right">\
                            </div>\
                    <div style="position: absolute; width: 100%; top: 0">Ich bin ein output</div> \
                    </div>');


                }

                $("#" + type + "_" + counter).css({"top": top + "px", "left": left + "px"});

                var _in = $('.' + type + '_' + counter + '_in');
                $.each(_in, function () {
                    var id = $(this).attr("id");
                    ScriptGUI.add_endpoint(id, "input");
                });

                var _out = $('.' + type + '_' + counter + '_out');
                $.each(_out, function () {
                    var id = $(this).attr("id");
                    ScriptGUI.add_endpoint(id, "output");
                });

                //TODO es muss nur ein repaint gemacht werden wenn mehrere selected sind
                $(".fbs_element").drag(function( ev, dd ){
                    $( this ).css({
                                top: dd.offsetY/zoom,
                                left: dd.offsetX/zoom

                    });
                    jsPlumb.repaintEverything();
                },{ relative:true,



                });
//                    containment: "parent",
//                    distance: 5,
//                    snap: true,
//                    snapTolerance: 10,
//                    grid: [ 30, 30 ],
//                    available: ".fbs_selected",
//                    drag: function (event, ui) {
//                        jsPlumb.repaintEverything();
//                    }

//               );

                counter++;

            }
        });

        // Add Input
        $("#prg_panel").on("click", ".btn_add_input", function () {
            var id = $(this).attr("id");
            var n = id.split("btn_add_input_");
            var parrent = $("#left_" + n[1]).parent();
            var type = $(parrent).attr("id").split("_")[0];
            var index = $("#left_" + n[1]).children().length + 1;
            console.log(id);
            var add_id = type + '_' + n[1] + '_in' + index + '';
            console.log(add_id);

            $("#left_" + n[1]).append('\
                <div id="' + add_id + '"  class="div_input ' + type + '_' + n[1] + '_in"><a class="input_font">IN ' + index + '</a></div>\
                ');

            ScriptGUI.add_endpoint(add_id, "input");
            jsPlumb.repaintEverything();
        });

        // Select FBS
        $("#prg_panel").on("click", ".fbs_element", function (e) {
            if ($(e.target).is(".btn_add_input")) {
            } else {
                $(this).toggleClass("fbs_selected");
                console.log("add")
            }
            ;
        });

        // None select FBS
        $('#prg_panel').click(function (e) {
            if ($(e.target).is("#prg_panel")) {
                $(".fbs_element").removeClass("fbs_selected");
            }
        });


        //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
        // ICON Bar Button


        $("#img_set_left").click(function () {

            var items = $(".fbs_selected");
            if (items.length > 1) {

                function SortByName(a, b) {
                    var aName = $(a).offset().left;
                    var bName = $(b).offset().left;
                    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
                }

                items.sort(SortByName);
                var position = $(items[0]).offset().left - $("#prg_panel").offset().left;

                $.each(items, function () {
                    $(this).css("left", position);
                });
                jsPlumb.repaintEverything();
            }
        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );

        $("#img_set_right").click(function () {
            var items = $(".fbs_selected");
            if (items.length > 1) {
                function SortByName(a, b) {
                    var aName = $(a).offset().left;
                    var bName = $(b).offset().left;
                    return ((aName > bName) ? -1 : ((aName < bName) ? 1 : 0));
                }

                items.sort(SortByName);
                var position = $(items[0]).offset().left - $("#prg_panel").offset().left;

                $.each(items, function () {
                    $(this).css("left", position);
                });
                jsPlumb.repaintEverything();
            }
        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );

        $("#img_set_top").click(function () {
            var items = $(".fbs_selected");
            if (items.length > 1) {
                function SortByName(a, b) {
                    var aName = $(a).offset().top;
                    var bName = $(b).offset().top;
                    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
                }

                items.sort(SortByName);
                var position = $(items[0]).offset().top - $("#prg_panel").offset().top;

                $.each(items, function () {
                    $(this).css("top", position);
                });
                jsPlumb.repaintEverything();
            }
        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );

        $("#img_set_bottom").click(function () {
            var items = $(".fbs_selected");
            if (items.length > 1) {
                function SortByName(a, b) {
                    var aName = $(a).offset().top;
                    var bName = $(b).offset().top;
                    return ((aName > bName) ? -1 : ((aName < bName) ? 1 : 0));
                }

                items.sort(SortByName);
                var position = $(items[0]).offset().top - $("#prg_panel").offset().top;

                $.each(items, function () {
                    $(this).css("top", position);
                });
                jsPlumb.repaintEverything();
            }
        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );


        $("#img_set_steps").click(function () {
            var items = $(".fbs_selected");
            if (items.length > 1) {
                function SortByTop(a, b) {
                    var aName = $(a).offset().top;
                    var bName = $(b).offset().top;
                    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
                }

                function SortByLeft(a, b) {
                    var aName = $(a).offset().left;
                    var bName = $(b).offset().left;
                    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
                }

                var top_list = items.sort(SortByTop);
                var left_list = items.sort(SortByLeft);
                var left = $(left_list[0]).offset().left - $("#prg_panel").offset().left;
                var top = $(top_list[0]).offset().top - $("#prg_panel").offset().top;

                var step = 0;


                $.each(items, function () {
                    $(this).css("left", left + step);
                    $(this).css("top", top + step);

                    top = top + parseInt($(this).css("height").split("px")[0]) + 2;

                    console.log($(this).css("height").split("px")[0]);
                    console.log(top);

                    step = step + 30;
                });
                jsPlumb.repaintEverything();
            }

        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );


        var zoom = 1;

        $("#img_set_zoom").click(function () {

            $("#prg_panel").css({"zoom": 1});
            zoom = 1;
        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );
        $("#img_set_zoom_in").click(function () {
            zoom = zoom+0.1
            $("#prg_panel").css({"zoom": zoom});

        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );
        $("#img_set_zoom_out").click(function () {
            zoom = zoom-0.1
            $("#prg_panel").css({"zoom": zoom})

        }).hover(
                function () {
                    $(this).addClass("ui-state-focus");
                }, function () {
                    $(this).removeClass("ui-state-focus");
                }
        );


        //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX


        // Make btn Toolboxauswahl
        $("#toolbox_select").multiselect({
            multiple: false,
            header: false,
            noneSelectedText: false,
            selectedList: 1,
            minWidth: 150,
            height: 200
        });

        // Toolboxauswahl
        $("#toolbox_select").change(function () {
            $(".toolbox").hide();
            $("#toolbox_" + $(this).val()).show();
        });


    },

    add_endpoint: function (id, type) {


        if (type == "input") {
            var endpointStyle = {fillStyle: "green"};
            jsPlumb.addEndpoint(id, {
                anchor: "Left",
                isTarget: true,
                connector: "Flowchart",
                paintStyle: endpointStyle,
                endpoint: [ "Rectangle", { width: 30, height: 10} ]
            });
        }
        if (type == "output") {
            var endpointStyle = {fillStyle: "orange"};
            jsPlumb.addEndpoint(id, {
                anchor: "Right",
                isSource: true,
                maxConnections: -1,
                connector: "Flowchart",
                paintStyle: endpointStyle,
                endpoint: [ "Rectangle", { width: 30, height: 10} ]


            });

        }

    },


    make_struc: function () {

        var blocks = [];
        $("#prg_panel .fbs_element").each(function (idx, elem) {
            var $elem = $(elem);
            blocks.push({
                blockId: $elem.attr('id'),
                positionX: parseInt($elem.css("left"), 10),
                positionY: parseInt($elem.css("top"), 10)
            });
        });
        //            console.log(blocks);


        var connections = [];
        $.each(jsPlumb.getConnections(), function (idx, connection) {
            connections.push({
                connectionId: connection.id,
                pageSourceId: connection.sourceId,
                pageTargetId: connection.targetId
            });
        });
        console.log(connections);


        function SortByName(a, b) {

            var aName = a.positionX;
            var bName = b.positionX;
            return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
        }

        blocks.sort(SortByName);

        // Erstelle Scrip Stucktur
        var struck = []
        $.each(blocks, function () {
            var id = this["blockId"];
            var data = {
                type: "",
                input: [],
                output: []

            };

            data.type = this["blockId"].split("_")[0];

            $.each(connections, function () {
                var add = [];
                input = this["pageTargetId"].split("_");
                input_name = (input[0] + "_" + input[1]);

                output = this["pageSourceId"].split("_");
                output_name = (output[0] + "_" + output[1]);

                if (input_name == id) {

                    add.push(input[2]);
                    add.push(this.pageSourceId);
                    data.input.push(add)
                }

                if (output_name == id) {
                    var add = [];
                    add.push(output[2]);
                    add.push(this.pageTargetId);
                    data.output.push(add)
                }

            });

            struck.push(data);
        });
        console.log(struck)
    }
};


ScriptGUI.Main();


</script>
</body>
</html>
